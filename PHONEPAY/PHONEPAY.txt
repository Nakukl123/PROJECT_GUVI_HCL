CREATE DATABASE PHONEPAY;

USE DATABASE PHONEPAY;
CREATE SCHEMA PHONEPAY_STATE;

CREATE OR REPLACE TABLE RAW_AGGREGATED_INSURANCE (
    STATE                STRING,
    YEAR                 INTEGER,
    QUARTER              INTEGER,
    INSURANCE_TYPE       STRING,
    TRANSACTION_COUNT    NUMBER,
    TRANSACTION_AMOUNT   NUMBER(38,2),
    LOAD_TIMESTAMP       TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP
);

SELECT * FROM RAW_AGGREGATED_INSURANCE;

CREATE OR REPLACE TABLE RAW_AGGREGATED_TRANSACTION (
    STATE                STRING,
    YEAR                 INTEGER,
    QUARTER              INTEGER,
    TRANSACTION_TYPE     STRING,
    TRANSACTION_COUNT    NUMBER,
    TRANSACTION_AMOUNT   NUMBER(38,2),
    LOAD_TIMESTAMP       TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP
);

SELECT * FROM RAW_AGGREGATED_TRANSACTION;

SELECT DISTINCT TRANSACTION_TYPE FROM RAW_AGGREGATED_TRANSACTION;

CREATE OR REPLACE TABLE RAW_AGGREGATED_USER (
    STATE STRING,
    YEAR INTEGER,
    QUARTER INTEGER,
    DEVICE_BRAND STRING,
    USER_COUNT NUMBER,
    USER_PERCENTAGE FLOAT,
    LOAD_TIMESTAMP TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP
);

SELECT * FROM RAW_AGGREGATED_USER;

SELECT DISTINCT DEVICE_BRAND FROM RAW_AGGREGATED_USER;

CREATE OR REPLACE TABLE RAW_MAP_TRANSACTION (
    GEO_LEVEL           STRING,        -- STATE / DISTRICT
    STATE               STRING,
    DISTRICT            STRING,
    YEAR                INTEGER,
    QUARTER             INTEGER,
    TRANSACTION_COUNT   NUMBER,
    TRANSACTION_AMOUNT  NUMBER(38,2),
    LOAD_TIMESTAMP      TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP
);

SELECT * FROM RAW_MAP_TRANSACTION;

CREATE OR REPLACE TABLE RAW_MAP_INSURANCE (
    GEO_LEVEL          STRING,
    STATE              STRING,
    DISTRICT           STRING,
    YEAR               INTEGER,
    QUARTER            INTEGER,
    INSURANCE_COUNT    NUMBER,
    INSURANCE_AMOUNT   NUMBER,
    LOAD_TIMESTAMP     TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP
);


CREATE OR REPLACE TABLE RAW_MAP_USER (
    GEO_LEVEL         STRING,
    STATE             STRING,
    DISTRICT          STRING,
    YEAR              INTEGER,
    QUARTER           INTEGER,
    REGISTERED_USERS  NUMBER,
    APP_OPENS         NUMBER,
    LOAD_TIMESTAMP    TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP
);

SELECT * FROM RAW_MAP_USER;

CREATE OR REPLACE TABLE RAW_TOP_TRANSACTION (
    CATEGORY_TYPE        STRING,   -- STATE / DISTRICT / PINCODE (from JSON key)
    SOURCE_GEO_LEVEL     STRING,   -- Folder level: STATE / PINCODE
    SOURCE_GEO_NAME      STRING,   -- State or pincode folder name
    ENTITY_NAME          STRING,   -- Actual top entity (district / pincode / state)
    YEAR                 INTEGER,
    QUARTER              INTEGER,
    TRANSACTION_COUNT    NUMBER,
    TRANSACTION_AMOUNT   NUMBER,
    LOAD_TIMESTAMP       TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP
);


SELECT * FROM RAW_TOP_TRANSACTION;


CREATE OR REPLACE TABLE RAW_TOP_INSURANCE (
    CATEGORY_TYPE        STRING,
    SOURCE_GEO_LEVEL     STRING,
    SOURCE_GEO_NAME      STRING,
    ENTITY_NAME          STRING,
    YEAR                 INTEGER,
    QUARTER              INTEGER,
    INSURANCE_COUNT      NUMBER,
    INSURANCE_AMOUNT     NUMBER,
    LOAD_TIMESTAMP       TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP
);

SELECT * FROM RAW_TOP_INSURANCE;

CREATE OR REPLACE TABLE RAW_TOP_USER (
    CATEGORY_TYPE        STRING,
    SOURCE_GEO_LEVEL     STRING,
    SOURCE_GEO_NAME      STRING,
    ENTITY_NAME          STRING,
    YEAR                 INTEGER,
    QUARTER              INTEGER,
    REGISTERED_USERS     NUMBER,
    LOAD_TIMESTAMP       TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP
);

SELECT * FROM RAW_TOP_USER;

--1 OVERALL KPIs (Transactions)

SELECT
    SUM(TRANSACTION_COUNT) AS TOTAL_TRANSACTIONS,
    SUM(TRANSACTION_AMOUNT) AS TOTAL_TRANSACTION_VALUE
FROM RAW_AGGREGATED_TRANSACTION;

--2 OVERALL USERS
SELECT
    SUM(user_count) AS TOTAL_USERS
FROM RAW_AGGREGATED_USER;

--3 OVERALL INSURANCE

SELECT
    SUM(TRANSACTION_COUNT) AS TOTAL_INSURANCE_TRANSACTIONS
FROM RAW_AGGREGATED_INSURANCE;


--4 PAYMENT PERFORMANCE (Category-wise)

SELECT
    TRANSACTION_TYPE,
    SUM(TRANSACTION_COUNT) AS TOTAL_TRANSACTIONS,
    SUM(TRANSACTION_AMOUNT) AS TOTAL_AMOUNT
FROM RAW_AGGREGATED_TRANSACTION
GROUP BY TRANSACTION_TYPE
ORDER BY TOTAL_AMOUNT DESC;

--5 PAYMENT PERFORMANCE (Category-wise)

SELECT
    TRANSACTION_TYPE,
    SUM(TRANSACTION_COUNT) AS TOTAL_TRANSACTIONS,
    SUM(TRANSACTION_AMOUNT) AS TOTAL_AMOUNT
FROM RAW_AGGREGATED_TRANSACTION
GROUP BY TRANSACTION_TYPE
ORDER BY TOTAL_AMOUNT DESC;


--6 TOP DISTRICTS / PINCODES (TRANSACTIONS)

SELECT
    CATEGORY_TYPE,
    ENTITY_NAME,
    SUM(TRANSACTION_AMOUNT) AS TOTAL_AMOUNT
FROM RAW_TOP_TRANSACTION
GROUP BY CATEGORY_TYPE, ENTITY_NAME
ORDER BY TOTAL_AMOUNT DESC
LIMIT 10;

--7 USER ENGAGEMENT (STATE-WISE)

SELECT
    STATE,
    SUM(USER_COUNT) AS TOTAL_USERS
FROM RAW_AGGREGATED_USER
GROUP BY STATE
ORDER BY TOTAL_USERS DESC;

--8 INSURANCE ADOPTION (STATE-WISE)

SELECT
    STATE,
    SUM(TRANSACTION_COUNT) AS TOTAL_INSURANCE
FROM RAW_AGGREGATED_INSURANCE
GROUP BY STATE
ORDER BY TOTAL_INSURANCE DESC;


--9 YEAR-WISE TRANSACTION TREND

SELECT
    YEAR,
    SUM(TRANSACTION_AMOUNT) AS TOTAL_AMOUNT
FROM RAW_AGGREGATED_TRANSACTION
GROUP BY YEAR
ORDER BY YEAR;

--10QUARTERLY TRANSACTION TREND

SELECT
    YEAR,
    QUARTER,
    SUM(TRANSACTION_AMOUNT) AS TOTAL_AMOUNT
FROM RAW_AGGREGATED_TRANSACTION
GROUP BY YEAR, QUARTER
ORDER BY YEAR, QUARTER;

--11 TRANSACTIONS vs USERS (STATE COMPARISON)

SELECT
    t.STATE,
    SUM(t.TRANSACTION_AMOUNT) AS TOTAL_TRANSACTION_AMOUNT,
    SUM(u.USER_COUNT) AS TOTAL_USERSx
FROM RAW_AGGREGATED_TRANSACTION t
JOIN RAW_AGGREGATED_USER u
    ON t.STATE = u.STATE
GROUP BY t.STATE
ORDER BY TOTAL_TRANSACTION_AMOUNT DESC;

